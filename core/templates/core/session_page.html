{# core/templates/core/session_page.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}Sesión {{ session_id }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Sesión de Validación</h1>
    <p><strong>ID Sesión:</strong> <span id="session-id-display">{{ session_id }}</span></p> {# Cambiado ID para evitar conflicto con json_script #}
    <p><strong>URL Validada:</strong> <a id="target-url" href="{{ session_url }}" target="_blank">{{ session_url }}</a></p>
    <hr>

    <div class="row">
        <div class="col-md-8">
            <h4>Navegador Simulado</h4>
            <div id="browser-info" style="min-height: 150px; border: 1px solid #ccc; background-color: #f8f9fa; padding: 15px; border-radius: 5px;">
                <p><strong>Estado Actual:</strong> <span id="session-status" class="fw-bold">{{ initial_status|default:"Iniciando..." }}</span></p>

                {# --- NUEVO: Contenedor para el enlace VNC (inicialmente oculto) --- #}
                <div id="vnc-link-container" style="display: none; margin-top: 15px;">
                     <a id="vnc-link" href="#" target="_blank" class="btn btn-success">
                         <i class="fas fa-external-link-alt"></i> Abrir Navegador Interactivo (VNC)
                     </a>
                     <small class="d-block text-muted mt-2">Interactúa con el navegador en la nueva pestaña y luego finaliza la sesión aquí.</small>
                </div>
                {# --- FIN Enlace VNC --- #}

                 {# --- NUEVO: Botón Finalizar (inicialmente deshabilitado) --- #}
                 <div id="finish-button-container" style="margin-top: 20px;">
                     <button id="finish-button" class="btn btn-danger" disabled>
                         <i class="fas fa-stop-circle"></i> Finalizar Sesión y Procesar
                     </button>
                 </div>
                 {# --- FIN Botón Finalizar --- #}

                  {# --- NUEVO: Contenedor para el enlace al reporte (inicialmente oculto) --- #}
                <div id="report-link-container" style="display: none; margin-top: 15px;">
                     <a id="report-link" href="#" target="_blank" class="btn btn-primary">
                         <i class="fas fa-file-alt"></i> Ver Reporte de Validación
                     </a>
                </div>
                {# --- FIN Enlace Reporte --- #}

            </div>
        </div>
        <div class="col-md-4">
            <h4>DataLayers Capturados (Próximamente)</h4> {# Actualizado título #}
            <div id="datalayer-list" style="max-height: 500px; overflow-y: auto; border: 1px solid #ccc; background-color: #f8f9fa; padding: 10px;">
                {# La captura y visualización se manejarán después del procesamiento #}
                <p class="text-muted">Los DataLayers se procesarán al finalizar la sesión.</p>
            </div>
        </div>
    </div>
</div>

{# Pasar el session_id y la URL de status a JavaScript de forma segura #}
{{ session_id|json_script:"session-id-data" }}
{# Usamos {% url %} para generar la URL dinámicamente #}
<script type="application/json" id="status-url-data">
    "{% url 'get_session_status' session_id %}"
</script>


{% endblock %}

{% block extra_js %}
   <script src="{% static 'core/js/session_app.js' %}"></script>
{% endblock %}
